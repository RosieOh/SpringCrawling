<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebDriver 테스트</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/css/crawling-test.css}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/test">
                <i class="fas fa-spider me-2"></i>크롤링 테스트
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/test">홈</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/test/beautifulsoup">BeautifulSoup</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/test/webdriver">WebDriver</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/swagger-ui.html" target="_blank">API 문서</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="jumbotron bg-gradient-info text-white p-4 rounded">
                    <h1 class="display-5">
                        <i class="fas fa-car me-3"></i>WebDriver 기반 크롤링 테스트
                    </h1>
                    <p class="lead">Jsoup, Selenium, API 호출을 통한 다양한 크롤링 방식을 테스트해보세요</p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-cog me-2"></i>크롤링 설정
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="webdriverForm">
                            <div class="mb-3">
                                <label for="url" class="form-label">URL <span class="text-danger">*</span></label>
                                <input type="url" class="form-control" id="url" name="url" 
                                       placeholder="https://example.com" required>
                                <div class="form-text">크롤링할 웹사이트의 URL을 입력하세요</div>
                            </div>

                            <div class="mb-3">
                                <label for="type" class="form-label">크롤링 타입 <span class="text-danger">*</span></label>
                                <select class="form-select" id="type" name="type" required>
                                    <option value="">크롤링 타입을 선택하세요</option>
                                    <option value="simple">SIMPLE - Jsoup (간단한 HTML 파싱)</option>
                                    <option value="javascript">JAVASCRIPT - Selenium (JavaScript 렌더링)</option>
                                    <option value="api">API - REST API 호출</option>
                                </select>
                                <div class="form-text">크롤링 방식을 선택하세요</div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="titleSelector" class="form-label">제목 선택자</label>
                                        <input type="text" class="form-control" id="titleSelector" name="titleSelector" 
                                               placeholder="h1, .title, #main-title">
                                        <div class="form-text">제목을 추출할 CSS 선택자</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="contentSelector" class="form-label">내용 선택자</label>
                                        <input type="text" class="form-control" id="contentSelector" name="contentSelector" 
                                               placeholder=".content, .description, p">
                                        <div class="form-text">내용을 추출할 CSS 선택자</div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="linkSelector" class="form-label">링크 선택자</label>
                                        <input type="text" class="form-control" id="linkSelector" name="linkSelector" 
                                               placeholder="a, .link, a[href]">
                                        <div class="form-text">링크를 추출할 CSS 선택자</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="imageSelector" class="form-label">이미지 선택자</label>
                                        <input type="text" class="form-control" id="imageSelector" name="imageSelector" 
                                               placeholder="img, .image, img[src]">
                                        <div class="form-text">이미지를 추출할 CSS 선택자</div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-outline-secondary me-md-2" id="clearBtn">
                                    <i class="fas fa-eraser me-2"></i>초기화
                                </button>
                                <button type="submit" class="btn btn-info" id="crawlBtn">
                                    <i class="fas fa-play me-2"></i>크롤링 시작
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-bolt me-2"></i>빠른 테스트
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <button class="btn btn-outline-primary w-100 mb-2" onclick="quickTest('https://news.naver.com', 'simple')">
                                    <i class="fas fa-newspaper me-2"></i>네이버 뉴스 (Jsoup)
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-success w-100 mb-2" onclick="quickTest('https://github.com/trending', 'simple')">
                                    <i class="fab fa-github me-2"></i>GitHub 트렌딩 (Jsoup)
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-info w-100 mb-2" onclick="quickTest('https://jsonplaceholder.typicode.com/posts', 'api')">
                                    <i class="fas fa-code me-2"></i>JSON API 테스트
                                </button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <button class="btn btn-outline-warning w-100 mb-2" onclick="quickTest('https://stackoverflow.com/questions', 'simple')">
                                    <i class="fab fa-stack-overflow me-2"></i>Stack Overflow (Jsoup)
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-danger w-100 mb-2" onclick="quickTest('https://www.reddit.com/r/Python/', 'javascript')">
                                    <i class="fab fa-reddit me-2"></i>Reddit (Selenium)
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-dark w-100 mb-2" onclick="quickTest('https://news.ycombinator.com/', 'simple')">
                                    <i class="fas fa-hacker-news me-2"></i>Hacker News (Jsoup)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-lightbulb me-2"></i>크롤링 타입 가이드
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h6><i class="fas fa-code me-2 text-primary"></i>SIMPLE (Jsoup)</h6>
                            <p class="small mb-2">정적 HTML 페이지에 적합합니다.</p>
                            <ul class="small">
                                <li>빠른 속도</li>
                                <li>낮은 리소스 사용</li>
                                <li>JavaScript 미지원</li>
                            </ul>
                        </div>

                        <div class="mb-3">
                            <h6><i class="fas fa-car me-2 text-success"></i>JAVASCRIPT (Selenium)</h6>
                            <p class="small mb-2">동적 콘텐츠가 있는 SPA에 적합합니다.</p>
                            <ul class="small">
                                <li>JavaScript 렌더링 지원</li>
                                <li>실제 브라우저 환경</li>
                                <li>높은 리소스 사용</li>
                            </ul>
                        </div>

                        <div class="mb-3">
                            <h6><i class="fas fa-plug me-2 text-info"></i>API (HTTP Client)</h6>
                            <p class="small mb-2">REST API 호출에 적합합니다.</p>
                            <ul class="small">
                                <li>JSON 데이터 처리</li>
                                <li>빠른 속도</li>
                                <li>구조화된 데이터</li>
                            </ul>
                        </div>

                        <hr>

                        <h6><i class="fas fa-search me-2"></i>선택자 예제</h6>
                        <ul class="small">
                            <li><code>h1</code> - 모든 h1 태그</li>
                            <li><code>.class</code> - class가 "class"인 요소</li>
                            <li><code>#id</code> - id가 "id"인 요소</li>
                            <li><code>a[href]</code> - href 속성이 있는 링크</li>
                            <li><code>img[src]</code> - src 속성이 있는 이미지</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-line me-2"></i>크롤링 결과
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="loading" class="text-center d-none">
                            <div class="spinner-border text-info" role="status">
                                <span class="visually-hidden">크롤링 중...</span>
                            </div>
                            <p class="mt-2">크롤링 중입니다. 잠시만 기다려주세요...</p>
                            <div class="alert alert-info mt-3">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    Selenium을 사용하는 경우 브라우저가 시작되므로 시간이 더 걸릴 수 있습니다.
                                </small>
                            </div>
                        </div>

                        <div id="result" class="d-none">
                            <div id="resultContent"></div>
                        </div>

                        <div id="error" class="alert alert-danger d-none">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>오류 발생</h6>
                            <div id="errorMessage"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 빠른 테스트
        function quickTest(url, type) {
            document.getElementById('url').value = url;
            document.getElementById('type').value = type;
            
            // 타입에 따른 기본 선택자 설정
            if (type === 'simple' || type === 'javascript') {
                document.getElementById('titleSelector').value = 'h1, h2, .title';
                document.getElementById('contentSelector').value = 'p, .content, .description';
                document.getElementById('linkSelector').value = 'a[href]';
                document.getElementById('imageSelector').value = 'img[src]';
            } else if (type === 'api') {
                // API의 경우 선택자 초기화
                document.getElementById('titleSelector').value = '';
                document.getElementById('contentSelector').value = '';
                document.getElementById('linkSelector').value = '';
                document.getElementById('imageSelector').value = '';
            }
            
            // 폼 제출
            document.getElementById('webdriverForm').dispatchEvent(new Event('submit'));
        }

        // 폼 초기화
        function clearForm() {
            document.getElementById('webdriverForm').reset();
            document.getElementById('result').classList.add('d-none');
            document.getElementById('error').classList.add('d-none');
        }

        // 결과 표시
        function showResult(data) {
            const resultDiv = document.getElementById('result');
            const resultContent = document.getElementById('resultContent');
            
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle me-2"></i>기본 정보</h6>
                        <ul class="list-unstyled">
                            <li><strong>URL:</strong> ${data.url || 'N/A'}</li>
                            <li><strong>제목:</strong> ${data.title || 'N/A'}</li>
                            <li><strong>상태:</strong> <span class="badge bg-success">${data.status}</span></li>
                            <li><strong>응답 시간:</strong> ${data.responseTime}ms</li>
                            <li><strong>크롤링 시간:</strong> ${new Date(data.crawledAt).toLocaleString()}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-chart-bar me-2"></i>통계</h6>
                        <ul class="list-unstyled">
                            <li><strong>추출된 데이터 수:</strong> ${data.extractedData ? Object.keys(data.extractedData).length : 0}</li>
                            <li><strong>메타데이터 수:</strong> ${data.metadata ? Object.keys(data.metadata).length : 0}</li>
                        </ul>
                    </div>
                </div>
            `;

            if (data.extractedData && Object.keys(data.extractedData).length > 0) {
                html += `
                    <hr>
                    <h6><i class="fas fa-database me-2"></i>추출된 데이터</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>선택자</th>
                                    <th>결과</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                for (const [key, value] of Object.entries(data.extractedData)) {
                    const displayValue = Array.isArray(value) ? value.join(', ') : value;
                    html += `
                        <tr>
                            <td><code>${key}</code></td>
                            <td>${displayValue || 'N/A'}</td>
                        </tr>
                    `;
                }
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            if (data.metadata && Object.keys(data.metadata).length > 0) {
                html += `
                    <hr>
                    <h6><i class="fas fa-tags me-2"></i>메타데이터</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>키</th>
                                    <th>값</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                for (const [key, value] of Object.entries(data.metadata)) {
                    html += `
                        <tr>
                            <td><code>${key}</code></td>
                            <td>${value || 'N/A'}</td>
                        </tr>
                    `;
                }
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            if (data.content) {
                html += `
                    <hr>
                    <h6><i class="fas fa-file-text me-2"></i>페이지 내용 (일부)</h6>
                    <div class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">
                        <pre class="mb-0 small">${data.content.substring(0, 1000)}${data.content.length > 1000 ? '...' : ''}</pre>
                    </div>
                `;
            }

            resultContent.innerHTML = html;
            resultDiv.classList.remove('d-none');
        }

        // 오류 표시
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('error').classList.remove('d-none');
        }

        // WebDriver 폼 제출
        document.getElementById('webdriverForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            // 로딩 표시
            document.getElementById('loading').classList.remove('d-none');
            document.getElementById('result').classList.add('d-none');
            document.getElementById('error').classList.add('d-none');
            
            try {
                const response = await fetch('/test/webdriver/crawl', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(data)
                });
                
                const result = await response.json();
                
                document.getElementById('loading').classList.add('d-none');
                
                if (result.success) {
                    showResult(result.data);
                } else {
                    showError(result.error);
                }
            } catch (error) {
                document.getElementById('loading').classList.add('d-none');
                showError('네트워크 오류가 발생했습니다: ' + error.message);
            }
        });

        // 초기화 버튼
        document.getElementById('clearBtn').addEventListener('click', clearForm);
    </script>
</body>
</html>
